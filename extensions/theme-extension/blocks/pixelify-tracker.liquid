{% comment %}
  Pixel Tracker - Theme App Extension (App Embed)
  Dynamically fetches and uses real pixel IDs from your Pixelify dashboard
{% endcomment %}

{% if block.settings.enable_tracking %}
<script>
(function() {
  'use strict';
  
  var SHOP = '{{ shop.permanent_domain }}';
  var DEBUG = {{ block.settings.debug_mode | json }};
  var PROXY_URL = '/apps/pixel-api';
  
  if (DEBUG) console.log('[PixelTracker] Starting for shop:', SHOP);

  // Retry logic
  var retryCount = 0;
  var maxRetries = 3;
  var retryDelay = 1000;
  
  function fetchPixelConfig() {
    // Fetch the pixel configuration from the API
    return fetch(PROXY_URL + '/get-pixel-id?shop=' + encodeURIComponent(SHOP), {
      method: 'GET',
      headers: { 'Accept': 'application/json' }
    })
    .then(function(res) {
      var contentType = res.headers.get('content-type') || '';
      if (!contentType.includes('application/json')) {
        return res.text().then(function(text) {
          if (DEBUG) console.error('[PixelTracker] Non-JSON response:', text.substring(0, 200));
          throw new Error('Server returned non-JSON response');
        });
      }
      if (!res.ok) {
        return res.text().then(function(text) {
          try {
            var data = JSON.parse(text);
            throw new Error(data.error || 'API request failed');
          } catch (e) {
            // If not JSON or parsing failed, use status
            throw new Error('API request failed: ' + res.status + ' ' + res.statusText);
          }
        });
      }
      return res.json();
    });
  }
  
  function initializeTracker(data) {
    if (data.error) {
      console.warn('[PixelTracker] API error:', data.error);
      return;
    }
    
    // Store configuration globally
    window.PIXEL_TRACKER_ID = data.pixelId;
    window.PIXEL_TRACKER_NAME = data.appName;
    window.PIXEL_TRACKER_CONFIG = data.config || {};
    window.PIXEL_TRACKER_CUSTOM_EVENTS = data.customEvents || [];

    if (DEBUG) {
      console.log('[PixelTracker] âœ… Pixel loaded:', {
        name: data.appName,
        pixelId: data.pixelId,
        metaPixelId: data.metaPixelId,
        enabled: data.enabled
      });
    }
    
    // Load tracking script with the real pixel ID
    var params = new URLSearchParams();
    params.set('id', data.pixelId);
    params.set('shop', SHOP);
    
    var script = document.createElement('script');
    script.async = true;
    script.src = PROXY_URL + '/pixel.js?' + params.toString();
    script.onload = function() {
      if (DEBUG) console.log('[PixelTracker] Tracking script loaded for:', data.appName);
    };
    script.onerror = function() {
      console.error('[PixelTracker] Failed to load tracking script');
    };
    document.head.appendChild(script);
    
    // Initialize Facebook Pixel if configured
    if (data.metaPixelId && data.enabled) {
      try {
        !function(f,b,e,v,n,t,s)
        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', data.metaPixelId);
        fbq('track', 'PageView');
        if (DEBUG) console.log('[PixelTracker] âœ… Facebook Pixel initialized:', data.metaPixelId);
      } catch (fbError) {
        if (DEBUG) console.warn('[PixelTracker] Facebook Pixel error:', fbError);
      }
    }
  }
  
  function attemptInitialization() {
    fetchPixelConfig()
      .then(initializeTracker)
      .catch(function(err) {
        retryCount++;
        console.error('[PixelTracker] Init failed (attempt ' + retryCount + '/' + maxRetries + '):', err.message);

        // Don't retry on 404 errors (app not installed)
        var is404Error = err.message.includes('404') || err.message.includes('Not Found');

        if (!is404Error && retryCount < maxRetries) {
          if (DEBUG) console.log('[PixelTracker] Retrying in ' + retryDelay + 'ms...');
          setTimeout(attemptInitialization, retryDelay);
          retryDelay *= 2;
        } else {
          if (is404Error) {
            console.warn('[PixelTracker] App not installed on this shop. Tracking disabled.');
          } else {
            console.error('[PixelTracker] Failed after ' + maxRetries + ' attempts. Tracking disabled.');
          }
        }
      });
  }
  
  // Start initialization
  attemptInitialization();
})();
</script>
{% endif %}

{% schema %}
{
  "name": "Pixel Tracker",
  "target": "body",
  "settings": [
    {
      "type": "header",
      "content": "ðŸŽ¯ Pixel Tracking"
    },
    {
      "type": "paragraph",
      "content": "This extension automatically uses your active pixel from the Pixelify dashboard. Manage your pixels at: /admin/apps/pixelify"
    },
    {
      "type": "checkbox",
      "id": "enable_tracking",
      "label": "Enable Tracking",
      "default": true,
      "info": "Turn on/off all pixel tracking"
    },
    {
      "type": "checkbox",
      "id": "debug_mode",
      "label": "Debug Mode",
      "default": false,
      "info": "Show detailed logs in browser console"
    }
  ]
}
{% endschema %}
